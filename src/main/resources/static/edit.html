<<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Edit Animal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg sticky-top border-bottom border-dark">
    <div class="container">
      <a class="navbar-brand" href="/index.html">Animal Gallery</a>
    </div>
  </nav>

  <main class="container py-4" style="max-width:900px;">
    <h1 class="mb-3">Edit Animal</h1>
    <div id="status" class="alert d-none" role="alert"></div>

    <form id="form" enctype="multipart/form-data" novalidate>
      <div class="row g-3">
        <div class="col-md-6"><label class="form-label">Name</label><input id="name" name="name" class="form-control" required></div>
        <div class="col-md-6"><label class="form-label">Type</label><input id="type" name="type" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Age</label><input id="age" name="age" class="form-control" type="number" min="0"></div>
        <div class="col-md-8"><label class="form-label">Image URL</label><input id="imageUrl" name="imageUrl" class="form-control"></div>
        <div class="col-md-4"><label class="form-label">Upload Image</label><input id="picture" name="picture" type="file" class="form-control" accept="image/*"></div>
        <div class="col-12"><label class="form-label">Description</label><textarea id="description" name="description" class="form-control" rows="4"></textarea></div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button id="saveBtn" class="btn btn-primary" type="submit">Update</button>
        <a class="btn btn-secondary" href="/index.html">Cancel</a>
      </div>
    </form>
  </main>

  <script type="module">
    document.addEventListener('DOMContentLoaded', ()=>{
      const base = '/animals';
      const form = document.getElementById('form');
      const status = document.getElementById('status');
      const save = document.getElementById('saveBtn');

      const params = new URLSearchParams(location.search);
      const raw = params.get('id');
      const id = (raw && raw !== 'undefined' && !Number.isNaN(Number(raw))) ? raw : null;

      function show(kind,msg){
        if(status){ status.className = 'alert alert-'+kind; status.textContent = msg; status.classList.remove('d-none'); }
        else console.log(kind, msg);
      }

      if(!id){
        show('danger','Missing or invalid id. Open Edit from the list.');
        if(save) save.disabled = true;
        console.error('edit: invalid id', raw);
        return;
      }

      // load all animals and find the one by id (avoid GET /animals/{id} 404)
      fetch('/animals')
        .then(r => { if (!r.ok) throw new Error('Failed to load animals: ' + r.status); return r.json(); })
        .then(list => {
          const a = list.find(x => String(x.id ?? x.animalId ?? x.animalID ?? x.animal_id) === String(id));
          if(!a){ show('warning','Animal not found'); return; }
          document.getElementById('name').value = a.name ?? '';
          document.getElementById('type').value = a.type ?? '';
          document.getElementById('age').value = a.age ?? '';
          document.getElementById('imageUrl').value = a.imageUrl ?? '';
          document.getElementById('description').value = a.description ?? '';
        })
        .catch(e => { console.error(e); show('danger','Could not load animal'); });

      form.addEventListener('submit', async e=>{
        e.preventDefault();
        if(!form.reportValidity()) return;
        const fd = new FormData(form);
        if(fd.get('age')) fd.set('age', Number(fd.get('age')));
        save.disabled = true;
        const orig = save.innerHTML; save.innerHTML = 'Updating…';
        try{
          const res = await fetch(`${base}/update/${encodeURIComponent(id)}`, { method:'POST', body: fd });
          const text = await res.text().catch(()=> '');
          if(!res.ok) throw new Error(text || `Update failed: ${res.status}`);
          show('success','Updated — returning to gallery...');
          setTimeout(()=> location.href = '/index.html', 300);
        }catch(err){
          console.error(err); show('danger', err.message || 'Update failed');
        }finally{ save.disabled = false; save.innerHTML = orig; }
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>